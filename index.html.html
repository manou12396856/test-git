<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Double acc√®s QR ‚Äî V√©rif Google Sheet</title>
  <!-- Librairies CDN -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root{--card-bg:#fff;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:12px;background:#f6f7fb}
    .wrap{max-width:820px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center}
    h1{font-size:18px;margin:0}
    .card{background:var(--card-bg);border:1px solid #e6e9ee;padding:14px;border-radius:12px;margin:12px 0;box-shadow:0 1px 4px rgba(20,20,40,0.03)}
    label{display:block;margin:6px 0;font-size:14px}
    input,select,button{font-size:15px;padding:8px;border-radius:8px;border:1px solid #d0d6e0}
    #reader{width:100%;max-width:420px;margin:10px 0}
    .ok{color:green;font-weight:700}
    .no{color:red;font-weight:700}
    small{color:var(--muted)}
    ul{padding-left:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .note{font-size:13px;color:var(--muted)}
    footer{font-size:13px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Double acc√®s QR ‚Äî V√©rif Google Sheet (mobile)</h1>
    </header>

    <div class="card">
      <h3>1) Configuration (obligatoire)</h3>
      <p class="note">Pour que la v√©rification fonctionne : <strong>publie ta feuille</strong> (Fichier ‚Üí Publier sur le web) ET rends-la partageable en lecture pour "Toute personne disposant du lien" (ou publie sur le web). L'endpoint utilis√© : <code>https://docs.google.com/spreadsheets/d/&lt;SHEET_ID&gt;/gviz/tq?tqx=out:json</code></p>

      <label>SHEET_ID : <input id="sheetIdInput" placeholder="colle le SHEET_ID ici"></label>
      <label>Nom de la colonne d'identifiant (ex: id, matricule, email) : <input id="idColumnInput" placeholder="ex: id"></label>
      <div class="row">
        <button id="saveSheetBtn">Enregistrer</button>
        <button id="checkSheetBtn">Tester la connexion</button>
      </div>
      <p id="sheetTest" class="note"></p>
    </div>

    <div class="card">
      <h3>2) G√©n√©rer un QR (participant)</h3>
      <p class="note">Saisis l'ID tel qu'il figure dans la colonne choisie puis clique G√©n√©rer.</p>
      <label>Identifiant : <input id="userId" placeholder="Ex: 12345 ou email@domaine" /></label>
      <div class="row">
        <button id="genBtn">G√©n√©rer QR</button>
        <button id="downloadBtn">T√©l√©charger le QR (image)</button>
      </div>
      <div id="qrcode" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h3>3) Scanner (contr√¥leur)</h3>
      <p class="note">Appuie sur <em>D√©marrer scanner</em> et dirige la cam√©ra vers le QR affich√© sur l'√©cran du participant.</p>
      <div id="reader"></div>
      <div class="row">
        <button id="startScan">D√©marrer scanner</button>
        <button id="stopScan" disabled>Arr√™ter</button>
        <button id="clearLog">Effacer log</button>
      </div>
      <p id="scanResult"></p>
      <h4>Log local (derni√®res validations)</h4>
      <div id="logArea" class="note"></div>
    </div>

    <footer class="card">
      <strong>Attention :</strong>
      <ul>
        <li>Pour la cam√©ra, ouvre la page via <u>https</u> (ex : GitHub Pages, Netlify). Les navigateurs mobiles n'autorisent pas la cam√©ra sur file://.</li>
        <li>Si tu veux que la feuille reste priv√©e, on peut ajouter une solution avec Google Apps Script pour mettre une API s√©curis√©e.</li>
      </ul>
    </footer>
  </div>

  <script>
    // ---- Helpers et √©tat ----
    let sheetId = '';
    let idColumnName = '';
    let html5QrcodeScanner = null;
    let scanning = false;
    let canScanAgain = true;

    // Elements
    const sheetInput = document.getElementById('sheetIdInput');
    const idColInput = document.getElementById('idColumnInput');
    const saveBtn = document.getElementById('saveSheetBtn');
    const checkBtn = document.getElementById('checkSheetBtn');
    const sheetTestP = document.getElementById('sheetTest');
    const genBtn = document.getElementById('genBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const qrcodeContainer = document.getElementById('qrcode');
    const startBtn = document.getElementById('startScan');
    const stopBtn = document.getElementById('stopScan');
    const resultP = document.getElementById('scanResult');
    const logArea = document.getElementById('logArea');
    const clearLogBtn = document.getElementById('clearLog');

    // load saved
    sheetInput.value = localStorage.getItem('sheet_id') || '';
    idColInput.value = localStorage.getItem('id_column') || '';
    renderLog();

    saveBtn.addEventListener('click', ()=>{
      const sid = sheetInput.value.trim();
      const col = idColInput.value.trim();
      if(!sid || !col) { alert('Colle le SHEET_ID et le nom de la colonne d\'identifiant.'); return; }
      localStorage.setItem('sheet_id', sid);
      localStorage.setItem('id_column', col);
      sheetId = sid; idColumnName = col;
      alert('SHEET_ID et colonne enregistr√©s.');
    });

    checkBtn.addEventListener('click', async ()=>{
      const sid = sheetInput.value.trim();
      const col = idColInput.value.trim();
      if(!sid || !col){ alert('Colle le SHEET_ID et le nom de la colonne.'); return; }
      sheetTestP.textContent = 'Test en cours...';
      try{
        const url = `https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:json`;
        const resp = await fetch(url);
        const text = await resp.text();
        const json = JSON.parse(text.substring(text.indexOf('{')));
        // V√©rifier en-t√™tes
        const headers = json.table.cols.map(c=>c.label ? c.label.toString().toLowerCase() : '');
        if(headers.includes(col.toLowerCase())){
          sheetTestP.textContent = 'Connexion OK ‚Äî colonne trouv√©e.';
        }else{
          sheetTestP.textContent = 'Connexion OK ‚Äî mais la colonne n\'a pas √©t√© trouv√©e. Colonnes disponibles : ' + headers.join(', ');
        }
      }catch(e){
        sheetTestP.textContent = 'Erreur test : v√©rifie que la feuille est publi√©e et accessible en lecture.';
        console.error(e);
      }
    });

    // QR generation
    genBtn.addEventListener('click', ()=>{
      const id = document.getElementById('userId').value.trim();
      if(!id){ alert('Entre l\'ID.'); return; }
      qrcodeContainer.innerHTML = '';
      const q = new QRCode(qrcodeContainer, {text:id, width:260, height:260});
    });

    // T√©l√©charger le QR en PNG
    downloadBtn.addEventListener('click', ()=>{
      const img = qrcodeContainer.querySelector('img') || qrcodeContainer.querySelector('canvas');
      if(!img){ alert('G√©n√®re d\'abord un QR.'); return; }
      // si image
      if(img.tagName === 'IMG'){
        const src = img.src;
        const a = document.createElement('a'); a.href = src; a.download = 'qr.png'; a.click();
      }else{
        // canvas
        const data = img.toDataURL('image/png');
        const a = document.createElement('a'); a.href = data; a.download = 'qr.png'; a.click();
      }
    });

    // Scanner
    startBtn.addEventListener('click', async ()=>{
      sheetId = localStorage.getItem('sheet_id') || sheetInput.value.trim();
      idColumnName = localStorage.getItem('id_column') || idColInput.value.trim();
      if(!sheetId || !idColumnName){ alert('SHEET_ID ou colonne manquante.'); return; }

      if(!html5QrcodeScanner){ html5QrcodeScanner = new Html5Qrcode('reader'); }
      startBtn.disabled = true; stopBtn.disabled = false; resultP.innerHTML = 'Scanning...';

      try{
        await html5QrcodeScanner.start({ facingMode: 'environment' }, { fps: 10, qrbox: {width:250, height:250} }, async (decodedText) => {
          if(!canScanAgain) return;
          canScanAgain = false; // bloque jusqu'√† traitement
          await onQrScanned(decodedText);
          // autoriser un nouveau scan apr√®s 2s
          setTimeout(()=>{ canScanAgain = true; }, 1500);
        }, (err)=>{
          // ignore
        });
      }catch(e){ alert('Impossible d\'activer la cam√©ra: ' + e); startBtn.disabled=false; stopBtn.disabled=true; }
    });

    stopBtn.addEventListener('click', async ()=>{
      if(html5QrcodeScanner){ await html5QrcodeScanner.stop(); html5QrcodeScanner.clear(); html5QrcodeScanner = null; }
      startBtn.disabled = false; stopBtn.disabled = true; resultP.innerHTML = '';
    });

    clearLogBtn.addEventListener('click', ()=>{ localStorage.removeItem('validation_log'); renderLog(); });

    async function onQrScanned(scannedValue){
      resultP.innerHTML = `QR scann√© : <strong>${scannedValue}</strong> ‚Äî v√©rification...`;
      try{
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
        const resp = await fetch(url);
        const text = await resp.text();
        const json = JSON.parse(text.substring(text.indexOf('{')));
        const cols = json.table.cols;
        const rows = json.table.rows || [];

        // trouver l'index de la colonne demand√©e (case-insensitive)
        const targetIndex = cols.findIndex(c => (c.label||'').toString().toLowerCase() === idColumnName.toLowerCase());
        if(targetIndex === -1){
          resultP.innerHTML = '<span class="no">Colonne id introuvable ‚Äî utilise le bouton "Tester la connexion" pour voir les colonnes.</span>';
          return;
        }

        let found = null;
        for(const r of rows){
          const cell = r.c[targetIndex];
          const cellValue = cell ? (cell.v + '') : '';
          if(cellValue.trim() === scannedValue.trim()) { found = r; break; }
        }

        if(found){
          // construire un affichage propre avec les colonnes pr√©sentes
          const info = cols.map((c,i)=>({name: c.label || ('col'+i), value: (found.c[i] ? found.c[i].v : '')}));
          let html = '<span class="ok">AUTORIS√â</span><br/>';
          html += '<ul>' + info.map(x=>`<li><strong>${x.name}:</strong> ${x.value}</li>`).join('') + '</ul>';
          html += `<small>Heure : ${new Date().toLocaleString()}</small>`;
          resultP.innerHTML = html;

          pushLog({id: scannedValue, status: 'AUTORIS√â', when: new Date().toISOString(), details: info.slice(0,4)});
        }else{
          resultP.innerHTML = '<span class="no">REFUS√â ‚Äî ID non trouv√© dans la liste</span>';
          pushLog({id: scannedValue, status: 'REFUS√â', when: new Date().toISOString()});
        }
      }catch(err){
        console.error(err);
        resultP.innerHTML = '<span class="no">Erreur lors de la v√©rification (v√©rifie que la feuille est publique)</span>';
      }
    }

    // petit log local
    function pushLog(entry){
      const log = JSON.parse(localStorage.getItem('validation_log')||'[]');
      log.unshift(entry);
      if(log.length>30) log.pop();
      localStorage.setItem('validation_log', JSON.stringify(log));
      renderLog();
    }
    function renderLog(){
      const log = JSON.parse(localStorage.getItem('validation_log')||'[]');
      if(!log.length){ logArea.innerHTML = '<em>Aucun enregistrement</em>'; return; }
      logArea.innerHTML = '<ol>' + log.map(l=>`<li><strong>${l.id}</strong> ‚Äî ${l.status} ‚Äî ${new Date(l.when).toLocaleString()}</li>`).join('') + '</ol>';
    }

  </script>
</body>
</html>

<!-- Ajout d'une version PRO + COMPLETE du syst√®me QR -->

<!-- ============================= -->
<!--   SECTION : VERSION PREMIUM   -->
<!-- ============================= -->

<h2>üî• VERSION PROFESSIONNELLE ‚Äî SYST√àME COMPLET DE SCAN QR + CONNEXION AUTOMATIQUE GOOGLE SHEET</h2>
<p>Voici un syst√®me QR professionnel, propre, s√©curis√© et pr√™t √† l‚Äôemploi. Il fonctionne directement avec Google Forms ‚Üí Google Sheets ‚Üí Scan QR.</p>

<hr>

<h3>üéØ COMMENT √áA FONCTIONNE</h3>
<ol>
<li>Les participants remplissent un Google Forms.</li>
<li>Les donn√©es arrivent directement dans une Google Sheet.</li>
<li>Tu mets le lien de la Sheet dans cette page.</li>
<li>La cam√©ra scanne un QR code ‚Üí la page check si l'ID existe dans la Sheet.</li>
<li>
Si oui ‚Üí Affiche le nom + statut + valide l‚Äôacc√®s.<br>
Si non ‚Üí Affiche refus.</li>
</ol>

<h3>üìå Fonctionnalit√©s Pro ajout√©es</h3>
<ul>
<li>‚úîÔ∏è Interface moderne</li>
<li>‚úîÔ∏è V√©rification en temps r√©el dans Google Sheets</li>
<li>‚úîÔ∏è Logs automatiques (dans le navigateur + possibilit√© Google Sheet)</li>
<li>‚úîÔ∏è D√©tection erreur r√©seau / erreur lecture</li>
<li>‚úîÔ∏è Double scan possible (Entr√©e et Sortie)</li>
<li>‚úîÔ∏è QR personnalis√©s</li>
</ul>

<hr>

<h2>üß© CODE HTML + JS COMPLET PROFESSIONNEL</h2>
<p>√Ä copier dans un fichier <b>index.html</b> et h√©berger sur Netlify / GitHub Pages.</p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="fr"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title>Syst√®me QR Professionnel&lt;/title&gt;
    &lt;style&gt;
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            text-align: center;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: auto;
        }
        #result-valid { color: green; font-weight: bold; }
        #result-invalid { color: red; font-weight: bold; }
        #video { width: 300px; border-radius: 8px; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;div class="card"&gt;
    &lt;h2&gt;üîç Scanner QR Code&lt;/h2&gt;
    &lt;p&gt;Assure-toi d'avoir bien entr√© le lien de ta Google Sheet ci-dessous.&lt;/p&gt;

    &lt;input id="sheetUrl" type="text" placeholder="Lien Google Sheet" style="width:90%; padding:10px"/&gt;
    &lt;br&gt;&lt;br&gt;

    &lt;button onclick="startScanner()" style="padding:10px 20px"&gt;üé• D√©marrer le Scanner&lt;/button&gt;

    &lt;br&gt;&lt;br&gt;
    &lt;video id="video" autoplay muted playsinline&gt;&lt;/video&gt;

    &lt;h3&gt;R√©sultat :&lt;/h3&gt;
    &lt;div id="result-valid" style="display:none"&gt;‚úîÔ∏è Valid√©&lt;/div&gt;
    &lt;div id="result-invalid" style="display:none"&gt;‚ùå Non trouv√©&lt;/div&gt;
    &lt;div id="nameDisplay"&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"&gt;&lt;/script&gt;
&lt;script&gt;
let stream;

async function startScanner() {
    const video = document.getElementById("video");
    const sheetUrl = document.getElementById("sheetUrl").value;

    if (!sheetUrl.includes("docs.google")) {
        alert("‚ùó Mets un lien Google Sheet valide.");
        return;
    }

    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;

    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");

    video.addEventListener("play", () =&gt; {
        const scanInterval = setInterval(() =&gt; {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const qr = jsQR(imageData.data, canvas.width, canvas.height);

                if (qr) {
                    validateID(qr.data, sheetUrl);
                    clearInterval(scanInterval);
                }
            }
        }, 700);
    });
}

async function validateID(scannedID, sheetUrl) {
    const apiUrl = sheetUrl.replace("edit#gid=0", "gviz/tq?tqx=out:json");

    try {
        const response = await fetch(apiUrl);
        const text = await response.text();
        const json = JSON.parse(text.substring(47, text.length - 2));

        const rows = json.table.rows.map(r =&gt; r.c.map(c =&gt; c ? c.v : ""));

        const found = rows.find(r =&gt; String(r[0]).trim() === String(scannedID).trim());

        if (found) {
            document.getElementById("result-valid").style.display = "block";
            document.getElementById("result-invalid").style.display = "none";
            document.getElementById("nameDisplay").innerHTML = "üë§ " + found[1];
        } else {
            document.getElementById("result-valid").style.display = "none";
            document.getElementById("result-invalid").style.display = "block";
            document.getElementById("nameDisplay").innerHTML = "";
        }
    } catch (error) {
        alert("Erreur lors de la lecture de la Google Sheet.");
        console.log(error);
    }
}
&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<hr>

<h2>üöÄ Pr√™t √† l‚Äôutiliser</h2>
<p>
1. Les participants remplissent le Google Form.<br>
2. Tu r√©cup√®res automatiquement la Sheet associ√©e.<br>
3. Tu colles le lien dans la page.<br>
4. Tu scannes ‚Üí r√©sultat instantan√©.<br>
</p>

<h3>Si tu veux : je peux aussi ajouter un dashboard Google Sheet avec statistiques (nb scans, entr√©es/sorties, etc.)</h3>

